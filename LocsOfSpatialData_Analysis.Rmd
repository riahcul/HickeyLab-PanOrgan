---
title: "LocsOfSpatialData_Analysis"
output: html_document
---

```{r}
library(RColorBrewer)
library(tidyverse)
library(wordcloud)
library(dplyr)
library(ggplot2)
library(tidytext)
library(treemap)
library(paletteer)
library(stringr)
library(scales)
library(plotly)
library(networkD3)
library(treemapify)
library(hexbin)
library(ggforce)
library(hrbrthemes)
```

```{r}
data = read.csv("/Users/riahcul/Downloads/041525_locsofspatialdata.csv")
data[data == ""] <- NA
```

```{r}
data <- data |>
  mutate(year = str_extract(folder_name, "\\d{4}"))

data$tissue <- trimws(data$tissue)

x_freqs <- data |>
  group_by(x_col_name) |>
  summarize(Frequency = n()) |>
  arrange(desc(Frequency))

y_freqs <- data |>
  group_by(y_col_name) |>
  summarize(Frequency = n()) |>
  arrange(desc(Frequency))

celltype_freqs <- data |>
  group_by(celltype_col_name) |>
  summarize(Frequency = n()) |>
  arrange(desc(Frequency))

uniqueregion_freqs <- data |>
  group_by(uniqueregion_col_name) |>
  summarize(Frequency = n()) |>
  arrange(desc(Frequency))

modality_freqs <- data |>
  group_by(modality, year) |>
  summarize(Frequency = n(), .groups = "drop") |>
  arrange(desc(Frequency))

disease_freqs <- data |>
  group_by(disease) |>
  summarize(Frequency = n()) |>
  arrange(desc(Frequency))

disease_year <- data |>
  group_by(disease, year, priority) |>
  summarize(Frequency = n(), .groups = "drop") |>
  arrange(desc(Frequency))

tissue_freqs <- data |> 
  group_by(tissue, year, priority) |> 
  summarize(Frequency = n(), .groups = "drop") |> 
  arrange(desc(Frequency))
```

```{r}
x_freqs |>
  ggplot(aes(x = reorder(x_col_name, Frequency), y=Frequency, fill = x_col_name)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    title = "X-Column Name Diversity",
    x = "X-Column Name across Datasets",
  ) +
  coord_flip()

y_freqs |>
  ggplot(aes(x = reorder(y_col_name, Frequency), y=Frequency, fill = y_col_name)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    title = "Y-Column Name Diversity",
    x = "Y-Column Name across Datasets",
  ) +
  coord_flip()

celltype_freqs |>
  ggplot(aes(x = reorder(celltype_col_name, Frequency), y=Frequency, fill = celltype_col_name)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    title = "Cell Type Name Diversity",
    x = "Cell Type Column Name across Datasets",
  ) +
  coord_flip()

uniqueregion_freqs |>
  ggplot(aes(x = reorder(uniqueregion_col_name, Frequency), y=Frequency, fill = uniqueregion_col_name)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    title = "Unique Region Name Diversity",
    x = "Unique Region Column Name across Datasets",
  ) +
  coord_flip()

modality_freqs |>
  ggplot(aes(x = reorder(modality, Frequency), y=Frequency, fill = modality)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    title = "Variation in Modality",
    x = "Modality",
    subtitle = "Need to update"
  ) +
  coord_flip()

disease_freqs |>
  ggplot(aes(x = reorder(disease, Frequency), y=Frequency, fill = disease)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    title = "Variation in Disease",
    x = "Diseases across Datasets",
  ) +
  coord_flip()

tissue_freqs |> 
  ggplot(aes(x = reorder(tissue, Frequency), y=Frequency, fill = tissue)) + geom_bar(stat ="identity") + 
  theme_minimal() + 
  theme(legend.position = "none") + 
  labs(
    title = "Variation in Disease", 
    x = "Diseases across Datasets") + 
  coord_flip()
```

```{r}
data_long <- disease_freqs |> 
  mutate(disease_split = strsplit(disease, ",")) |> 
  unnest(disease_split)

disease_counts <- data_long |> 
  group_by(disease_split) |> 
  summarize(Frequency = sum(Frequency)) |> 
  arrange(desc(Frequency))

disease_counts |> 
  ggplot(aes(x = reorder(disease_split, -Frequency), y=Frequency)) + 
  geom_point(size=3) + 
  geom_segment(aes(x= disease_split, xend=disease_split, y=0, yend = Frequency)) + 
  labs( 
    title = "Variation in Disease across Spatial Datasets", 
    x = "Diseases across Datasets") + 
  theme_minimal() + 
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1), 
        axis.text.x= element_text(angle=25, vjust=.6))
```

```{r}
#col_vector <- c("#FDBF6F", "#BC80BD", "#A6CEE3", "#F4A582", "#ab296a", "#8DD3C7", "#0c541f", "#E31A1C", "#B2DF8A", "#33A02C", "#FF7F00", "#FB9A99", "#1F78B4", "#CAB2D6", "#FFED6F", "#6A3D9A")
col_vector <- c("#B3E2CD", "#E4C5AF", "#CBD5E8", "#F4CAE4",  
"#E6F5C9", "#FFD6E0", "#F1E2CC", "#CCCCCC",  
"#A6CEE3", "#FF9AA2", "#FFCC80", "#CAB2D6",  
"#EDE275", "#B15928", "#8DD3C7", "#BC80BD")

moddata_long <- modality_freqs |> 
  mutate(modality_split = strsplit(modality, ",")) |> 
  unnest(modality_split) |>
  mutate(modality_split = str_replace(modality_split, "MxIF", "MIF"))

modality_counts <- moddata_long |> 
  group_by(modality_split, year) |> 
  summarize(Frequency = sum(Frequency), .groups = "drop") |> 
  arrange(desc(Frequency))

print(modality_counts)

#my_palette <- paletteer_dynamic("cartography::green.pal", 17)
#my_palette <- colorRampPalette(c("darkorchid4", "darkslateblue", "deeppink3", "deepskyblue2", "blue2"))(17) 

modality_counts |> 
  ggplot( 
  aes(x = year, y = Frequency, fill = modality_split)) + 
  geom_bar(stat = "identity", color = "black") +
  scale_fill_manual(values = col_vector) +
theme_classic() +
  labs(
    title = "Modality Prevalence Across Years (2017-2024)",
  )
  
  


```

```{r}
modality_counts |> 
  ggplot(aes(x = reorder(modality_split, -Frequency), y=Frequency)) + 
  geom_point(size=3) + 
  geom_segment(aes(x= reorder(modality_split, -Frequency), xend=modality_split, y=0, yend = Frequency)) + 
  labs( 
    title = "Variation in Modalities across Spatial Datasets", 
    x = "Modalities across Datasets") + 
  theme_minimal() + 
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1), 
        axis.text.x= element_text(angle=60, vjust=.55))
```

```{r}
uniqueregion_freqs |> 
  ggplot(aes(x = reorder(uniqueregion_col_name, Frequency), y=Frequency)) + 
  geom_point(size=3) + 
  geom_segment(aes(x= uniqueregion_col_name, xend=uniqueregion_col_name, y=0, yend = Frequency)) + 
  labs( 
    title = "Unique Region Name Diversity", 
    x = "Unique Region Names across Datasets") + 
  theme_minimal() + 
  theme(panel.border = element_rect(color ="black", fill = NA, size = 1), 
        axis.text.x= element_text(angle=0, vjust=.6)) + 
  coord_flip()

```
```{r}
tissuedata_long <- tissue_freqs |> 
  mutate(tissue_split = strsplit(tissue, ",")) |> 
  unnest(tissue_split)

tissuedata_long$tissue_split <- trimws(tissuedata_long$tissue_split)

tissue_counts <- tissuedata_long |> 
  group_by(tissue_split) |> 
  summarize(Frequency = sum(Frequency)) |> 
  arrange(desc(Frequency))

tissue_counts |> 
  ggplot(aes(x = reorder(tissue_split, Frequency), y=Frequency)) + 
  geom_point(size=3) + 
  geom_segment(aes(x= tissue_split, xend=tissue_split, y=0, yend = Frequency)) + 
  labs( 
    title = "Variation in Tissue across Spatial Datasets", 
    x ="Tissues across Datasets") + 
  theme_minimal() + 
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1), 
        axis.text.x= element_text(angle=0, vjust=.6)) + 
  coord_flip()
```

```{r}

title_freqs <- data |> 
  group_by(title, year, modality) |> 
  summarize(Frequency = n(), .groups = "drop") |> 
  arrange(desc(Frequency))

title_freqs <- title_freqs |> 
  rename(titles = title)

titledata_long <- title_freqs |> 
  mutate(title_split = strsplit(titles, " ")) |> 
  unnest(title_split)

titledata_long <- titledata_long |> 
  mutate(title_split = gsub(",", "", title_split)) |> 
  mutate(title_split = tolower(title_split))

title_counts <- titledata_long |> 
  group_by(title_split) |> 
  summarize(Frequency = sum(Frequency)) |> 
  arrange(desc(Frequency))

extra_words <- c("of", "and", "in", "the", "by", "to", "with", "a", "for", "from", "an", "at", "the", "is", "but")

title_clean_counts <- title_counts |> 
  filter(!title_split %in% extra_words)

print(title_clean_counts)
```

```{r}
#why is quality so bad???
wordcloud(words = title_clean_counts$title_split, freq = title_clean_counts$Frequency,
          min.freq = 1, scale = c(1.5, 0.475), random.order = FALSE, rot.per = .25, colors=brewer.pal(8,"Dark2"))
```

```{r}
treemap(x_freqs, 
        index = c("x_col_name"), 
        vSize = "Frequency", 
        vColor = "Frequency", 
        title = "X-Column Name Diversity in Spatial Datasets", 
        palette = "Set3", 
        draw = TRUE)
```

```{r}
treemap(y_freqs, 
        index = c("y_col_name"), 
        vSize = "Frequency", 
        vColor = "Frequency", 
        title = "Y-Column Name Diversity in Spatial Datasets", 
        palette = "Set3", 
        draw = TRUE)
```
```{r}
celltype_freqs <- na.omit(celltype_freqs)
png("treee.png", width = 1200, height = 800)
treemap(celltype_freqs, 
        index = c("celltype_col_name"), 
        vSize = "Frequency", 
        vColor = "Frequency", 
        title = "Cell Type Name Diversity in Spatial Datasets", 
        palette = "Pastel1", 
        #fontsize.labels = 14,
        force.print.labels = TRUE,
        overlap.labels = .5,
        align.labels = list(c("center", "center")),
        draw = TRUE)
png("treeee.png")
print(p)
dev.off()

print(celltype_freqs)
```

```{r}
treemap(uniqueregion_freqs, 
        index = c("uniqueregion_col_name"), 
        vSize = "Frequency", 
        vColor = "Frequency", 
        title = "Unique Region Name Diversity in Spatial Datasets", 
        palette = "Pastel2", 
        draw = TRUE)

```
```{r}
metaadded_freqs <- data |>
  group_by(metadata_file_added) |>
  summarize(Frequency = n()) |>
  arrange(desc(Frequency))

metaadded_freqs <- metaadded_freqs |> mutate(
  metadata_file_added = if_else(is.na(metadata_file_added), "No", metadata_file_added)
  )

print(metaadded_freqs)

mypalette <- brewer.pal(3, "Pastel1") 

Prop <- c(36, 32)
pie(Prop, labels = c("Metadata file added", "Metadata file not added"), col=mypalette)

metaadded_freqs$fraction = metaadded_freqs$Frequency / sum(metaadded_freqs$Frequency)
metaadded_freqs$ymax = cumsum(metaadded_freqs$fraction)
metaadded_freqs$ymin = c(0, head(metaadded_freqs$ymax, n=-1))
metaadded_freqs$labelPosition <- (metaadded_freqs$ymax + metaadded_freqs$ymin) / 2
metaadded_freqs$label <- paste0(metaadded_freqs$metadata_file_added, "\n value: ", metaadded_freqs$Frequency)

metaadded_freqs |>
  ggplot(
    aes(ymax = ymax, ymin = ymin, xmax = 4, xmin = 3, fill = metadata_file_added)
  ) +
  geom_rect() +
  geom_label(x=3.5, aes(y=labelPosition, label =label), size=4) +
  scale_fill_brewer(palette = "BuPu") +
 # scale_fill_paletteer_d("lisa::JohnSingerSargent_2") +
  coord_polar(theta = "y") +
  xlim(c(2,4)) +
  theme_void() +
  theme(legend.position = "none") +
  labs(
    title = "Metadata File Added?"
  )
 
```
```{r}
email_freqs <- data |>
  group_by(need_to_email) |>
  summarize(Frequency = n()) |>
  arrange(desc(Frequency))

email_freqs <- email_freqs |>
  mutate(
    need_to_email = if_else(is.na(need_to_email), "No", need_to_email)
  )

print(email_freqs)

email_md_freqs <- data |>
  group_by(need_to_email_md) |>
  summarize(Frequency = n()) |>
  arrange(desc(Frequency))

email_md_freqs <- email_md_freqs |>
  mutate(
    need_to_email_md = if_else(is.na(need_to_email_md), "No", need_to_email_md)
  )

print(email_md_freqs)
```
```{r}
mypalette1 <- brewer.pal(3, "Purples") 
mypalette2 <- brewer.pal(3, "OrRd") 

needtoemail <- c(7, 61)
pie(needtoemail, labels = c("Need to email (7)", "Don't need to email (61)"), col=mypalette1) 

needtoemailmd <- c(8, 60)
pie(needtoemailmd, labels = c("Need to email for metadata (8)", "Don't need to email for metadata (60)"), col=mypalette2)



```
```{r}
lab_freqs <- data |>
  group_by(lab) |>
  summarize(Frequency = n()) |>
  arrange(desc(Frequency))

lab_freqs |>
  ggplot(aes(x = reorder(lab, Frequency), y=Frequency, fill = lab)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_paletteer_d("cartography::pastel.pal", dynamic = TRUE) +
  labs(
    title = "Variation in Labs - more data viz can be done on this section if necessary",
    x = "Labs across Datasets",
  ) +
  coord_flip()
  
```
```{r}
priority_freqs <- data |>
  group_by(priority) |>
  summarize(Frequency = n()) |>
  arrange(desc(Frequency))

print(priority_freqs)

mypalette <- paletteer_dynamic("cartography::green.pal", 2)
priority_pie <- c(57, 11)
pie(priority_pie, labels = c("Labeled Single Cell (57)", "Unlabeled Single Cell (11)"), col=mypalette)

```
```{r}
wordcloud(words = lab_freqs$lab, freq = lab_freqs$Frequency, 
          min.freq = 1, scale = c(5, 1), random.order = FALSE, rot.per = .25, colors=brewer.pal(9,"Pastel1"))
```
```{r}

# 
# data <- data |>
#   mutate(tissue_new = strsplit(tissue, ",")) |>
#   unnest(tissue_new)
# 
# data <- data |>
#   mutate(modality_new = strsplit(modality, ",")) |>
#   unnest(modality_new)
# 
# data <- data |>
#   mutate(disease_new = strsplit(disease, ",")) |>
#   unnest(disease_new)
```

```{r}
print(lab_freqs)

palette_lab <- paletteer_dynamic("cartography::green.pal", 13)

labpie <- c(33, 8, 6, 5, 4, 4, 2, 1, 1, 1, 1, 1, 1)
pie(labpie, labels = c("Angelo", "Nolan", "Hickey", "Bodenmiller", "Sorger", "Walsh", "Burlingame", "Elemento", "Ginty", "Ho", "Lin & Tan", "Theodorescu", "Zou"), col=palette_lab) 

```
```{r}
tissue_year <- tissuedata_long |>
  group_by(tissue_split, year) |>
  summarize(Frequency = sum(Frequency)) |> 
  arrange(desc(Frequency))

# tissue_freqs |> 
#   ggplot( 
#   aes(x = year, y = Frequency, fill = modality_split)) + 
#   geom_bar(stat = "identity", color = "black") +
#   scale_fill_manual(values = col_vector) +
# theme_classic() +
#   
tissue_year |>
  ggplot(
    aes(x = year, fill = tissue_split)) +
    geom_bar(position = "dodge")
  
```
```{r}
redata_freqs <- data |>
  filter(emailed == "Yes") |>
  group_by(received_data) |>
  summarize(Frequency = n()) |>
  arrange(desc(Frequency))

redata_freqs <- redata_freqs |>
  mutate(
    received_data = if_else(is.na(received_data), "No", received_data)
  )

print(redata_freqs)
```
```{r}
mypalette4 <- brewer.pal(3, "Set2") 

redata <- c(5, 1)
pie(redata, labels = c("Received data after emailing (5)", "Didn't receive after emailing (1)"), col=mypalette4) 
```

```{r}
sex_freqs <- data |>
  filter(metadata_file_added == "Yes") |>
  group_by(sex_col_name) |>
  summarize(Frequency = n()) |>
  arrange(desc(Frequency))

sex_freqs <- sex_freqs |>
  mutate(
    sex_col_name = if_else(is.na(sex_col_name), "No", sex_col_name)
  ) 

print(sex_freqs)
```
```{r}
mypalette5 <- brewer.pal(3, "Blues") 

redata <- c(25, 11)
pie(redata, labels = c("'Sex' column in metadata file added (25)", "Doesn't have a 'sex' column (11)"), col=mypalette5) 
```
```{r}
age_freqs <- data |>
  filter(metadata_file_added == "Yes") |>
  group_by(age_col_name) |>
  summarize(Frequency = n()) |>
  arrange(desc(Frequency))

age_freqs <- age_freqs |>
  mutate(
    age_col_name = if_else(is.na(age_col_name), "No", age_col_name)
  ) 

print(age_freqs)
```

```{r}
mypalette6 <- brewer.pal(3, "PiYG") 

redata <- c(32, 4)
pie(redata, labels = c("'Age' col. in metadata file added (32)", "Doesn't have an 'age' column (4)"), col=mypalette6) 
```
```{r}
# breast lung lymph node colon skin tonsil
rawr <- brewer.pal(5, "Paired")
tissuedata_long |> 
  filter(tissue_split %in% c("breast", "lung", "lymph node", "colon", "skin")) |>
  ggplot( 
  aes(x = year, y = Frequency, fill = tissue_split)) + 
  geom_bar(stat = "identity") +
  facet_wrap(~priority) +
  scale_fill_manual(values = rawr) +
theme_classic() +
  labs(
    title = "Appearance of 5 Most Frequent Tissue Types by Priority",
  )

```
```{r}
disease_year <- disease_year |>
  mutate(disease_split = strsplit(disease, ",")) |> 
  unnest(disease_split)

boom <- brewer.pal(8, "Pastel1")

disease_year |>
  ggplot( 
  aes(x = year, y = Frequency, fill = disease_split)) + 
  geom_bar(stat = "identity") +
  facet_wrap(~priority) +
  scale_fill_manual(values = boom) +
theme_classic()
  
```


```{r}
tissuedata_long |>
  ggplot(
    aes(x = priority, y= Frequency)
  ) +
  geom_dotplot(binaxis = 'y', stackdir =)
```
```{r}
mycolors <- paletteer_c("ggthemes::Blue-Green Sequential", 3)
tissue_counts$tissue_split <- gsub("intestines", "intestine", tissue_counts$tissue_split)
tissue_counts <- tissue_counts |>
  mutate(freq_group = case_when(
    Frequency > 10 ~ ">10",
    Frequency >= 5 & Frequency <= 10 ~ "5-10",
    Frequency < 5 ~ "<5"
  ))

tissue_counts <- na.omit(tissue_counts)

treemap(tissue_counts, 
        index = c("freq_group", "tissue_split"), 
        vSize = "Frequency", 
        #vColor = "mycolors", 
        type = "index",
        fontsize.labels = 9,
        title = "Representation of Tissue Types by Frequency in Spatial Datasets - intestine & intestines",
        palette = mycolors, 
       drop.unused.levels = FALSE,
        fontface.labels = 1,
        sortID = "size",
        na.color = TRUE,
        draw = TRUE)
```
```{r}
treemap(tissue_counts, 
        index = c("tissue_split"), 
        vSize = "Frequency", 
        #vColor = "mycolors", 
        type = "index",
        fontsize.labels = 9,
        title = "Representation of Tissue Types - intestine & intestines",
        palette = "Pastel1", 
       drop.unused.levels = FALSE,
        fontface.labels = 1,
        sortID = "-size",
        na.color = TRUE,
        draw = TRUE)
```

```{r}
sample_data <- data.frame(group = c('Yes', 'No'), value1 = c(34, 35), value2  = c(7, 61), value3 = c(8, 60), value4 = c(59, 10), value5 = c(5,5))
#value1 = metadata file added
#value2 = need to email for metadata
#value3 = need to email
#value4 = labeled/unlabeled single cell
#value5 = NEED TO RECHECK
plot_ly() |>
  add_pie(data = sample_data, labels = ~`group`, values = ~`value3`,
          type = 'pie', hole = .7, sort = F,
          marker = list(line = list(width=2),
                        colors = c("#A6CEE3", "#1F78B4")),
          name = "Need to Email") |>
  add_pie(data = sample_data, labels = ~`group`, values = ~`value2`,
          domain = list(
            x = c(.15, .85),
            y = c(.15, .85)),
          sort = F,
          name = "Need to Email for Metadata") |>
  layout(
    title = "Nested Pie Chart for Needing to Email"
  )
```

```{r}
sample_data <- data.frame(group= c('Email for metadata', 'Email'), 
                          name= c('Yes', 'No'),
                   value= c(7, 52, 6, 53))

# create nested pie chart using ggplot
ggplot(sample_data, aes(x = factor(group), y = value, fill = factor(name))) +
          geom_col() +
         scale_x_discrete(limits = c("Email for metadata", "Email")) +
          coord_polar("y")
```
```{r}
fig <- plot_ly() 
fig <- fig |>
  add_trace(
  type = "funnel",
  y = c("Datasets in Locs of Spatial Data", "Need to email", "Need to email for metadata", "Received Data"),
  x = c(58, 7, 6, 5)) 
fig <- fig |>
  layout(yaxis = list(categoryarray = c("Datasets in Locs of Spatial Data", "Need to email", "Need to email for metadata", "Received Data")))

fig
```
```{r}
manuscript <- data[!duplicated(data$title) & !is.na(data$title), ]

```

```{r}
length(unique(na.omit(manuscript$title)))

manuscript$metadata_file_added[is.na(manuscript$metadata_file_added)] <- "No"
manuscript$need_to_email[is.na(manuscript$need_to_email)] <- "No"
manuscript$need_to_email_md[is.na(manuscript$need_to_email_md)] <- "No"
manuscript$email_drafted[is.na(manuscript$email_drafted)] <- "No"
manuscript$emailed[is.na(manuscript$emailed)] <- "No"
manuscript$has_tissue_data[is.na(manuscript$has_tissue_data)] <- "No"
manuscript$received_data[is.na(manuscript$received_data)] <- "No"
```

```{r}

# ONLY RECENT CHANGE IS THAT NOW, THERE SHOULD BE +2 IN THE EMAILED COLUMN AND +2 IN THE NEED TO EMAIL COLUMN
manuscript |>
  count(metadata_file_added) |>
  print()

manuscript |>
  count(need_to_email) |>
  print()

manuscript |>
  count(need_to_email_md) |>
  print()

manuscript |>
  count(email_drafted) |>
  print()

manuscript |>
  count(emailed) |>
  print()

manuscript |>
  count(has_tissue_data) |>
  print()

manuscript |>
  count(received_data) |>
  print()

manuscript |>
  count(priority) |>
  print()

manuscript |>
  filter(priority == "labeled_singlecell") |>
  count(metadata_file_added) |>
  print()
```
```{r}
fig <- plot_ly() 
fig <- fig |>
  add_trace(
  type = "funnel",
  y = c("Datasets in Locs of Spatial Data", "Labeled Single Cell", "Metadata File Added", "Need to Email", "Need to Email for Metadata", "Emailed", "Received Data"),
  x = c(60, 50, 32, 9, 8, 6, 5),
  textposition = "inside",
  textinfo = "value+percent initial",
  marker = list(color = c("#A6CEE3", "#B2DF8A", "#FB9A99",  "#FDBF6F", "#CAB2D6", "#FFFF99", "#8DD3C7"))) |>
  layout(
    title = "Funnel Chart of Data Processing 02/19/25",
    yaxis = list(categoryarray = c("Datasets in Locs of Spatial Data", "Labeled Single Cell", "Metadata File Added", "Need to Email", "Need to Email for Metadata", "Emailed", "Received Data")))

fig

#plotly_IMAGE(fig, width = 500, heaight = 500, format = "png", scale = 2, out_file = "funnelchart.png")
```

```{r}

```

```{r}
fig1 <- plot_ly(
  type = "sankey",
  orientation = "v",
  
  node = list(
    label = c("Datasets in Locs of Spatial Data", "Labeled Single Cell", "Metadata File Added", "Need to Email", "Need to Email for Metadata", "Received Data"),
    color = c("#A6CEE3", "#B2DF8A", "#FB9A99", "#FDBF6F", "#CAB2D6", "#FFFF99"),
    pad = 15,
    thickness = 20,
    line = list(
      color = "black",
      width = .5
    )
  ), 
  
  link = list(
    source = c(0, 1, 1, 3, 4, 4),
    target = c(1, 2, 3, 4, 5, 5),
    value = c(50, 31, 7, 6, 5)
  )
)

fig1 <- fig1 |> layout(
    title = "Sankey Diagram for Data Processing 02/25",
    font = list(
      size = 10
    )
)

fig1

```

```{r}
links <- data.frame(
  source = c("Datasets in Locs of Spatial Data", "Labeled Single Cell", "Metadata File Added", "Need to Email", "Need to Email for Metadata", "Received Data"),
  target = c("Labeled Single Cell", "Unlabeled Single Cell", "Metadata File Added", "Need to Email", "Need to Email for Metadata", "Received Data"),
  value = c(50, 9, 31, 7, 6, 5)
)

nodes <- data.frame(
  name = c(as.character(links$source),
           as.character(links$target)) |>
    unique()
)

links$IDsource <- match(links$source, nodes$name)-1
links$IDtarget <- match(links$target, nodes$name)-1

p <- sankeyNetwork(Links = links, Nodes = nodes,
                   Source = "IDsource", Target = "IDtarget",
                   Value = "value", NodeID = "name",
                   sinksRight = FALSE)

p
```
```{r}
#MOST UPDATED ONE!
fig1 <- plot_ly(
  type = "sankey",
  orientation = "v",
  
  node = list(
    label = c("Datasets in Locs of Spatial Data", "Labeled Single Cell", "Unlabeled Single Cell", "Metadata File Added", "Need to Email", "Emailed", "Received Data"),
    color = c("#A6CEE3", "#B2DF8A", "#FB9A99", "#FDBF6F", "#CAB2D6", "#FFFF99", "#8DD3C7"),
    pad = 15,
    thickness = 20,
    line = list(
      color = "black",
      width = .5
    )
  ), 
  
  link = list(
    source = c(0, 0, 1, 1, 4, 5),
    target = c(1, 2, 3, 4, 5, 6),
    value = c(50, 10, 32, 9, 6, 5)
  )
)

fig1 <- fig1 |> layout(
    title = "Sankey Diagram for Data Processing 02/25",
    font = list(
      size = 10
    )
)

fig1
```
```{r}
mypalette <- brewer.pal(10, "Set3")

tissuelocs_top10 <- head(tissue_counts, 10)

tissuelocs_top10 |>
  filter(tissue_split != "NA") |>
  ggplot(aes(
    x = reorder(tissue_split, Frequency),
    y = Frequency,
    fill = tissue_split
  )) +
  geom_bar(stat = "identity", color = "black") +
  coord_flip() +
  scale_fill_manual(values = mypalette) +
  theme_minimal() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  geom_text(aes(label = Frequency), position = position_dodge(width=.9), hjust = 1.2) +
  labs(
    title = "10 Most Frequent Tissue Types in Locs of Spatial Data",
    x = "Tissue Type"
  )
```
```{r}
disease_counts |>
  filter(disease_split != "NA") |>
  ggplot(
    aes(
    x = reorder(disease_split, Frequency),
    y = Frequency,
    fill = disease_split
  )) +
  geom_bar(stat = "identity", color = "black") +
  coord_flip() +
  scale_fill_manual(values = mypalette) +
  theme_minimal() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  geom_text(aes(label = Frequency), position = position_dodge(width=.9), hjust = 1.2) +
  labs(
    title = "Distribution of Disease in Locs of Spatial Data",
    subtitle = "Would be changing Pancreatic Cancer -> Cancer",
    x = "Tissue Type"
  )
```
```{r}
tis_modal_viz <- data |>
  mutate(
    tissue = str_trim(tissue),
    modality = str_trim(modality)
  ) |>
  separate_rows(tissue, sep = ",") |>
  separate_rows(modality, sep = ",") |>
  mutate(
    large_tissue_unit = case_when(
      tissue %in% c("colon", "liver", "small intestine", "intestine", "intestines", "neck", "stomach", "esophagus", "head", "pancreas") ~ "Digestive System",
      str_detect(tissue, regex("neck", ignore_case = TRUE)) ~ "Digestive System",
      str_detect(tissue, regex("esophagus", ignore_case = TRUE)) ~ "Digestive System",


      tissue %in% c("lymph node", "tonsil", "thymus", "spleen", "axilla", "chest wall") ~ "Immune System", 
      str_detect(tissue, regex("axilla", ignore_case = TRUE)) ~ "Immune System",
      str_detect(tissue, regex("tonsil", ignore_case = TRUE)) ~ "Immune System",
      str_detect(tissue, regex("chest wall", ignore_case = TRUE)) ~ "Immune System",


      tissue %in% c("breast", "ovarian", "decidua", "placenta", "prostate", "rectum") ~ "Reproductive System",
      str_detect(tissue, regex("breast", ignore_case = TRUE)) ~ "Reproductive System",
      tissue %in% c("lung") ~ "Respiratory System",
      str_detect(tissue, regex("lung", ignore_case = TRUE)) ~ "Respiratory System",

      tissue %in% c("brain") ~ "Nervous System",
      str_detect(tissue, regex("brain", ignore_case = TRUE)) ~ "Nervous System",

      tissue %in% c("kidney", "bladder", "urothelial") ~ "Urinary System",
      tissue %in% c("bone", "bone marrow") ~ "Musculoskeletal System",
      str_detect(tissue, regex("bone", ignore_case = TRUE)) ~ "Musculoskeletal System",
      tissue %in% c("skin", "melaloma") ~ "Integumentary System",
      str_detect(tissue, regex("skin", ignore_case = TRUE)) ~ "Integumentary System",
      
       tissue %in% c("salivary") ~ "Endocrine System",

      TRUE ~ "Other"
    )
) |>
  group_by(large_tissue_unit, tissue, modality) |>
  summarize(Frequency = n(), .groups = "drop") |>
  group_by(large_tissue_unit) |>
  mutate(total_Freq = sum(Frequency)) |>
  ungroup()


  
```

```{r}
tis_modal_viz <- tis_modal_viz |> 
  mutate(
    tissue = case_when(
      str_detect(tissue, regex("brain", ignore_case = TRUE)) ~ "brain",  # Standardize "brain" variations
      str_detect(tissue, regex("skin", ignore_case = TRUE)) ~ "skin",    # Standardize "skin" variations
      str_detect(tissue, regex("lung", ignore_case = TRUE)) ~ "lung",    # Standardize "lung" variations
      str_detect(tissue, regex("breast", ignore_case = TRUE)) ~ "breast", # Standardize "breast" variations
      str_detect(tissue, regex("esophagus", ignore_case = TRUE)) ~ "esophagus", # Standardize "breast" variations
      str_detect(tissue, regex("neck", ignore_case = TRUE)) ~ "neck", # Standardize "breast" variations
      str_detect(tissue, regex("tonsil", ignore_case = TRUE)) ~ "tonsil", # Standardize "breast" variations



      TRUE ~ tissue  # Leave other tissues unchanged
    )
  ) 

tis_modal_viz |> 
  filter(!(is.na(modality))) |>
  filter(!(is.na(tissue))) |>
  ggplot( 
  aes(x = tissue, y = Frequency, fill = modality)) + 
  geom_col() +
  facet_wrap(~large_tissue_unit, scales = "free_x") +
  scale_fill_manual(values = col_vector)+
theme_classic() +
  labs(
    title = "Tissues within Locations of Spatial by Modality and LTU",
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)  # Slant the x-axis labels
  )

```


```{r}
feb_metadata = read.csv("/Users/riahcul/Downloads/2025another_data.csv")
feb_metadata[feb_metadata == ""] <- NA
```

```{r}
age_md <- feb_metadata |>
  select(donor, age, sex) |>
  mutate(age = as.numeric(age)) |>
  mutate(age = round(age)) |>
   filter(!is.na(age)) |>
  mutate(age_bin = cut(age, breaks= seq(0,100, by = 10), right = FALSE)) |>
  distinct(donor, .keep_all = TRUE) |>
  group_by(age_bin, sex) |>
  count() |>
  ungroup()
  
```
```{r}
age_md |>
  ggplot(
    aes(x = age_bin, y = n, fill=age_bin)
  ) +
  geom_col() +
  labs(
    title = "Binned Ages within Metadata",
    x = "Ages (Binned)",
    y = "Frequency"
  ) +
  scale_fill_manual(values = mypalette) +
  theme_minimal() +
  theme(
    legend.position = "none"
  ) +
  geom_text(aes(label = n), position = position_dodge(width=.9), hjust = .5, vjust = 0)
```
```{r}
age_md |>
  filter(!is.na(sex)) |>
  ggplot(
    aes(x = age_bin, y = n, fill=sex)
  ) +
  geom_col(color = "black", size = 0.25) +
  labs(
    title = "Frequency of Binned Ages within Metadata",
    x = "Ages (Binned)",
    y = "Frequency"
  ) +
  scale_fill_manual(values = c("#A3C4DC", "#FFD3B6", "#A8E6CF"),
                    na.value = "#A8E6CF") +
  theme_minimal() 

```
```{r}
narrow_age_md <- feb_metadata |>
  select(donor, age, sex) |>
  mutate(age = as.numeric(age)) |>
  mutate(age = round(age)) |>
  filter(!is.na(sex), !is.na(age), age >= 30, age <= 79) |>
  
  mutate(age_bin = cut(age, breaks= seq(30,80, by = 5), right = FALSE)) |>
  distinct(donor, .keep_all = TRUE) |>

  group_by(age_bin, sex) |>
  count() |>
  ungroup()

narrow_age_md |>
  ggplot(
    aes(x = age_bin, y = n, fill=sex)
  ) +
  geom_col(color = "black", size = 0.25) +
  labs(
    title = "Frequency of Binned Ages (30-80) within Metadata",
    x = "Ages (Binned)",
    y = "Frequency"
  ) +
  scale_fill_manual(values = c("#A3C4DC", "#FFD3B6", "#A8E6CF"),
                    na.value = "#A8E6CF") +
  theme_minimal() 
```
```{r}
stc = read.csv("/Users/riahcul/Downloads/studytocell.csv")
stc[stc == ""] <- NA
```

```{r}
immune_stc <- stc |>
  filter(Renamed.Cell.Type == "Immune") |>
  group_by(Original.Cell.Type) |>
  count()
```


```{r}

treemap(immune_stc, 
        index = c("Original.Cell.Type"), 
        vSize = "n",
        vColor = "n", 
        title = "Renamed Cell Type = Immune", 
        palette = "Set3", 
        draw = TRUE)
```
```{r}
noise_stc <- stc |>
  filter(Renamed.Cell.Type == "Noise") |>
  group_by(Original.Cell.Type) |>
  count()

treemap(noise_stc, 
        index = c("Original.Cell.Type"), 
        vSize = "n",
        vColor = "n", 
        title = "Renamed Cell Type = Noise", 
        palette = "Set3", 
        draw = TRUE)
```
```{r}
undefined_stc <- stc |>
  filter(Renamed.Cell.Type == "Undefined") |>
  group_by(Original.Cell.Type) |>
  count()

treemap(undefined_stc, 
        index = c("Original.Cell.Type"), 
        vSize = "n",
        vColor = "n", 
        title = "Renamed Cell Type = Undefined", 
        palette = "Set3", 
        draw = TRUE)
```
```{r}
epi_stc <- stc |>
  filter(Renamed.Cell.Type == "Epithelial") |>
  group_by(Original.Cell.Type) |>
  count()

treemap(epi_stc, 
        index = c("Original.Cell.Type"), 
        vSize = "n",
        vColor = "n", 
        title = "Renamed Cell Type = Epithelial", 
        palette = "Set3", 
        draw = TRUE)
```

```{r}
tis_modal_viz |> 
  filter(!(is.na(modality))) |>
  filter(!(is.na(tissue))) |>
  mutate(large_tissue_unit = fct_reorder(large_tissue_unit, desc(total_Freq))) |>
  ggplot( 
  aes(x = large_tissue_unit, y = Frequency, fill = modality)) + 
  geom_bar(stat = "identity") +
  scale_fill_manual(values = col_vector)+
theme_classic() +
  labs(
    title = "Large Tissue Units within Locations of Spatial by Modality",
    x = "Large Tissue Unit") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)  # Slant the x-axis labels
  )
```
```{r}
ogcelltype_stc <- stc |>
  group_by(Original.Cell.Type) |>
  count()

treemap(ogcelltype_stc, 
        index = c("Original.Cell.Type"), 
        vSize = "n",
        vColor = "n", 
        title = "Original Cell Type", 
        palette = "Set3", 
        draw = TRUE)

unique_count <- n_distinct(stc$Original.Cell.Type)
print(paste("Total unique cell types:", unique_count))


```


```{r}
renamedcelltype_stc <- stc |>
  group_by(Renamed.Cell.Type) |>
  count()

treemap(renamedcelltype_stc, 
        index = c("Renamed.Cell.Type"), 
        vSize = "n",
        vColor = "n", 
        title = "Renamed Cell Type", 
        palette = "Set3", 
        draw = TRUE)

unique_counted <- n_distinct(stc$Renamed.Cell.Type)
print(paste("Total unique cell types:", unique_counted))

```
```{r}
ogcelltype_stc |>
  ggplot(
    aes(area = n, fill = Original.Cell.Type, label = Original.Cell.Type) 
  ) +
  geom_treemap() +
  geom_treemap_text(color = "white", place = "center", reflow = TRUE) +
  scale_fill_viridis_d(option = "inferno") +
  labs(
    title = "Original Cell Type (Before Standardization)"
  ) +
  theme(legend.position = "none")
```
```{r}
renamedcelltype_stc |>
  ggplot(
    aes(area = n, fill = Renamed.Cell.Type, label = Renamed.Cell.Type) 
  ) +
  geom_treemap() +
  geom_treemap_text(color = "white", place = "center", reflow = TRUE) +
  scale_fill_viridis_d(option = "inferno") +
  labs(
    title = "Renamed Cell Type"
  ) +
  theme(legend.position = "none")
```
```{r}
set.seed(123)

x <- rnorm(1000)
y <- rnorm(1000)

hb <- hexbin(x, y, xbins = 30)

hb1 <- hexbin(ogcelltype_stc$Original.Cell.Type, ogcelltype_stc$n, xbins =30)
plot(hb1)

```
```{r}
april_lolli = read.csv("/Users/riahcul/Downloads/040125hickey.csv")
```

```{r}
april_lolli |> 
  ggplot(aes(x = reorder(name, -count), y=count)) + 
  geom_point(size=3) + 
  geom_segment(aes(x= name, xend=name, y=0, yend = count)) + 
  labs( 
    title = "Variation in Disease across Spatial Datasets", 
    x = "Diseases across Datasets") + 
  theme_minimal() + 
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1), 
        axis.text.x= element_text(angle=25, vjust=.6))
```
```{r}
celltype_counts = read.csv("/Users/riahcul/Downloads/042025celltype_counts.csv")
```

```{r}
celltype_counts <- celltype_counts %>%
  mutate(year = str_extract(dataset_name, "^\\d{4}"))

year_study_counts <- celltype_counts |>
  distinct(dataset_name, year) |>
  count(year, name = "study_count")

df_bubble <- celltype_counts |>
  left_join(year_study_counts, by = "year")
```

```{r}
ggplot(df_bubble, aes(x = year, y = study_count, size = count, color = cell_type)) +
  geom_point(alpha = 0.7) +
  scale_size(range = c(3, 20)) +  # control bubble sizes 
  labs(title = "Cell Type Counts by Study Year",
       x = "Year of Study",
       y = "Number of Studies",
       size = "Cell Count",
       color = "Cell Type") +
  theme_minimal() +
  guides(size = "none")

```
```{r}
ggplot(df_bubble, aes(x = year, y = count, color = cell_type, group = cell_type)) +
  geom_line(size = 1.2, alpha = 0.8) +  # Line plot with a thicker line
  geom_point(size = 3, alpha = 0.7) +  # Add points to show data points
  labs(title = "Cell Type Counts by Study Year",
       x = "Year of Study",
       y = "Cell Count",
       color = "Cell Type") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +  # Rotate x-axis labels
  scale_color_viridis_d()  # Use color palette for better differentiation
```

```{r}
analysis_stc <- stc |>
  mutate(match_indicator = ifelse(Original.Cell.Type == Renamed.Cell.Type, 0, 1),
         dataset_id = as.numeric(factor(o))) 

match_props <- analysis_stc |>
  group_by(dataset_id) |>
  summarize(match_prop = mean(match_indicator))

analysis_stc <- analysis_stc |>
  left_join(match_props, by = "dataset_id") |>
  mutate(
    dataset_id = fct_reorder(factor(dataset_id), match_prop)
  )

analysis_stc |>
  ggplot(
    aes(x = dataset_id, fill = factor(match_indicator))
  ) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Representation of Renamed Cell Types in Each Dataset",
    x = "Datasets",
    y = "Percentage",
    fill = "Match Indicator"
  ) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks = element_blank()) +
scale_fill_manual(
  name = "",  # legend title
  labels = c("Original", "Renamed"),
  values = c("0" = "#A6CEE3", "1" = "#1F78B4")
)

ggsave("plot.png", width = 12, height = 8)
```



```{r}
library(ggalluvial)

top_flows <- stc %>%
  count(Original.Cell.Type, Renamed.Cell.Type, sort = TRUE)

filtered_flows <- top_flows %>%
  filter(n > 5)

ggplot(filtered_flows,
       aes(axis1 = Original.Cell.Type, axis2 = Renamed.Cell.Type, y = n)) +
  geom_alluvium(aes(fill = Renamed.Cell.Type), width = 1/12) +
  geom_stratum(width = 1/12, fill = "white", color = "black") +
  geom_text(stat = "stratum", aes(label = after_stat(stratum))) +
  theme_minimal() +
  labs(title = "Cell Type Renaming Flow",
       y = "Count",
       x = NULL) +
  theme(legend.position = "none",
        axis.text.x = element_blank())

ggsave("plot.png", width = 14, height = 10)
```

```{r}
fig <- plot_ly(df_bubble, labels = ~cell_type, values = ~cell_type_prop, type = 'pie',
               hole = 0.5, textinfo = 'label+percent') %>%
  layout(title = "Cell Type Proportions - 2018 Keren Cell")
fig
```
```{r}
fig <- plot_ly(
  labels = c(df_bubble$dataset_name, df_bubble$cell_type),
  parents = c(rep("", nrow(df_bubble)), rep("2018_Keren_Cell", nrow(df_bubble))),
  values = c(sum(df_bubble$cell_type_prop), df_bubble$cell_type_prop),
  type = 'sunburst',
  branchvalues = 'total'
) %>%
  layout(title = "Cell Type Distribution by Dataset (Sunburst)")
fig
```
```{r}
cell_type_counts <- df_bubble %>%
  group_by(cell_type) %>%
  summarise(study_total = sum(study_count), .groups = "drop")

# donut chart
fig <- plot_ly(cell_type_counts,
               labels = ~cell_type,
               values = ~study_total,
               type = 'pie',
               hole = 0.5,
               textinfo = 'label+value+percent') %>%
  layout(title = "Number of Studies per Cell Type")

fig
```

```{r}
library(plotly)
cell_type_study_count <- df_bubble |>
  distinct(cell_type, dataset_name) |>
  count(cell_type, name = "study_count")

plot_ly(cell_type_study_count,
        labels = ~cell_type,
        values = ~study_count,
        type = 'pie',
        hole = 0.5,
        textinfo = 'label+value+percent') |>
  layout(title = "Number of Studies Each Cell Type Appears In")

```

